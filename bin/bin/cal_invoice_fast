#!/bin/bash

# é«˜æ€§èƒ½å‘ç¥¨è®¡ç®—å™¨
# ä¼˜åŒ–ç‚¹ï¼šå‡å°‘å­shellã€é¿å…ä¸´æ—¶æ–‡ä»¶ã€ä½¿ç”¨å†…ç½®å‘½ä»¤

TOTAL=0
COUNT=0

process_dir() {
    local dir="${1:-.}"
    echo "ğŸ“ $dir"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    local dir_total=0
    local dir_count=0
    
    # ä½¿ç”¨æ•°ç»„å’Œglobbingï¼Œé¿å…findå’Œå­shell
    shopt -s nullglob
    local files=("$dir"/*_*_*)
    
    if [[ ${#files[@]} -eq 0 ]]; then
        echo "âš ï¸  æœªæ‰¾åˆ°å‘ç¥¨æ–‡ä»¶"
        echo
        return
    fi
    
    # ä½¿ç”¨å†…ç½®æ’åºå’Œæ•°ç»„å¤„ç†
    local sorted_files=()
    for file in "${files[@]}"; do
        [[ -f "$file" ]] && sorted_files+=("$(basename "$file")")
    done
    
    # ä½¿ç”¨printfæ’åºï¼ˆæ•°å€¼æ’åºï¼‰
    IFS=$'\n' read -r -d '' -a sorted_files <<<"$(printf '%s\n' "${sorted_files[@]}" | sort -t'_' -k1,1n)"
    
    for name in "${sorted_files[@]}"; do
        # ä½¿ç”¨å‚æ•°æ‰©å±•ä»£æ›¿æ­£åˆ™è¡¨è¾¾å¼
        IFS='_' read -r num amount rest <<<"$name"
        
        # éªŒè¯æ ¼å¼
        [[ $num =~ ^[0-9]+$ ]] && [[ $amount =~ ^[0-9]+(\.[0-9]+)?$ ]] || continue
        
        local ext="${name##*.}"
        printf "%-4s â”‚ Â¥%-8s â”‚ %-6s â”‚ %s\n" "$num" "$amount" "$ext" "${name%.*}"
        
        # ç›´æ¥è®¡ç®—ï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶
        dir_total=$(echo "$dir_total + $amount" | bc -l)
        ((dir_count++))
    done
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    printf "ğŸ“Š æ–‡ä»¶: %d ä¸ª  æ€»è®¡: Â¥%.2f\n" "$dir_count" "$dir_total"
    echo
    
    # ç›´æ¥æ›´æ–°å…¨å±€å˜é‡
    TOTAL=$(echo "$TOTAL + $dir_total" | bc -l)
    COUNT=$((COUNT + dir_count))
    
    shopt -u nullglob
}

# ä¸»ç¨‹åº
main() {
    if [[ $# -eq 0 ]]; then
        process_dir "."
    else
        for dir in "$@"; do
            [[ -d "$dir" ]] && process_dir "$dir"
        done
    fi
    
    if [[ $COUNT -gt 0 ]]; then
        echo "ğŸ¯ æ€»è®¡ï¼š$COUNT ä¸ªæ–‡ä»¶ï¼ŒÂ¥$TOTAL"
    fi
}

main "$@"