#!/usr/bin/env bash
# é€’å½’ä¼˜åŒ–ç‰ˆæœ¬ - ä¸“é—¨é’ˆå¯¹å¤§ç›®å½•æ ‘ä¼˜åŒ–
set -euo pipefail

target_dir="."
sha256_flag=false
recursive_flag=false
output_file="file_list.csv"
parallel_jobs=$(nproc 2>/dev/null || echo 4)

# è§£æå‚æ•°
while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--sha256)   sha256_flag=true; shift ;;
        -r|--recursive) recursive_flag=true; shift ;;
        -h|--help)
            cat <<EOF
ç”¨æ³•: $0 [ç›®å½•] [-s] [-r]
  -s, --sha256   è®¡ç®— SHA256
  -r, --recursive é€’å½’å­ç›®å½•
EOF
            exit 0 ;;
        *)
            if [[ -z ${target_dir_set:-} ]]; then
                target_dir="$1"; target_dir_set=1
            else
                echo "é”™è¯¯ï¼šå¤šä½™å‚æ•° '$1'" >&2; exit 1
            fi
            shift ;;
    esac
done

[[ -d "$target_dir" ]] || { echo "é”™è¯¯ï¼šç›®å½•ä¸å­˜åœ¨ '$target_dir'" >&2; exit 1; }

# è§„èŒƒåŒ–ç›®å½•è·¯å¾„
target_dir=$(realpath "$target_dir")
target_dir_prefix="${target_dir}/"

echo "ğŸ” æ‰«æç›®å½•: $target_dir"

# ä¸´æ—¶æ–‡ä»¶ç”¨äºæ‰¹é‡å¤„ç†
TEMP_DIR=$(mktemp -d)
trap 'rm -rf "$TEMP_DIR"' EXIT

{
    if $sha256_flag; then
        echo "path,size,sha256"
    else
        echo "path,size"
    fi

    if $recursive_flag; then
        # é€’å½’æ¨¡å¼ä¼˜åŒ–ç­–ç•¥
        if $sha256_flag; then
            # å¸¦å“ˆå¸Œçš„é€’å½’ï¼šåˆ†æ‰¹å¤„ç†é¿å…å†…å­˜çˆ†ç‚¸
            echo "ğŸ“Š é€’å½’æ‰«æå¹¶è®¡ç®—å“ˆå¸Œä¸­..." >&2
            
            find "$target_dir" -type f -print0 | \
            split -d -l 1000 --separator='\0' --verbose - "$TEMP_DIR/batch_" >&2 && \
            
            for batch_file in "$TEMP_DIR"/batch_*; do
                [[ -f "$batch_file" ]] || continue
                echo "å¤„ç†æ‰¹æ¬¡: $(basename "$batch_file")..." >&2
                
                cat "$batch_file" | \
                xargs -0 -P "$parallel_jobs" -I {} bash -c '
                    file="$1"
                    target_prefix="$2"
                    
                    # å¿«é€Ÿç›¸å¯¹è·¯å¾„è®¡ç®—
                    if [[ "$file" == "$target_prefix"* ]]; then
                        rel_path="${file#$target_prefix}"
                    else
                        rel_path="$(basename "$file")"
                    fi
                    
                    # CSVè½¬ä¹‰
                    if [[ "$rel_path" == *[\",]* ]]; then
                        rel_path="\"${rel_path//\"/\"\"}\""
                    fi
                    
                    # è·å–æ–‡ä»¶ä¿¡æ¯
                    if [[ -f "$file" ]]; then
                        size=$(stat -c "%s" "$file" 2>/dev/null || echo "0")
                        hash=$(sha256sum "$file" 2>/dev/null | cut -d" " -f1 || echo "")
                        printf "%s,%s,%s\n" "$rel_path" "$size" "$hash"
                    fi
                ' _ {} "$target_dir_prefix"
            done
        else
            # æ— å“ˆå¸Œé€’å½’ï¼šè¶…é«˜é€Ÿæ¨¡å¼
            echo "âš¡ é«˜é€Ÿé€’å½’æ‰«æä¸­..." >&2
            
            # ä½¿ç”¨findä¸€æ¬¡æ€§è·å–æ‰€æœ‰ä¿¡æ¯ï¼Œé¿å…é‡å¤éå†
            find "$target_dir" -type f -printf '%p|%s\n' | \
            while IFS='|' read -r file size; do
                # è¶…å¿«ç›¸å¯¹è·¯å¾„è®¡ç®—
                if [[ "$file" == "$target_dir_prefix"* ]]; then
                    rel_path="${file#$target_dir_prefix}"
                else
                    rel_path="$(basename "$file")"
                fi
                
                # æœ€å°åŒ–CSVè½¬ä¹‰
                case "$rel_path" in
                    *[\",]*) printf '"%s",%s\n' "${rel_path//\"/\"\"}" "$size" ;;
                    *) printf '%s,%s\n' "$rel_path" "$size" ;;
                esac
            done
        fi
    else
        # éé€’å½’æ¨¡å¼ä¿æŒåŸæœ‰é€»è¾‘
        if $sha256_flag; then
            echo "path,size,sha256"
            find "$target_dir" -maxdepth 1 -type f -print0 | \
            xargs -0 -P "$parallel_jobs" -I {} bash -c '
                file="$1"; target_prefix="$2"
                rel_path="$(basename "$file")"
                if [[ "$rel_path" == *[\",]* ]]; then
                    rel_path="\"${rel_path//\"/\"\"}\""
                fi
                size=$(stat -c "%s" "$file" 2>/dev/null || echo "0")
                hash=$(sha256sum "$file" 2>/dev/null | cut -d" " -f1 || echo "")
                printf "%s,%s,%s\n" "$rel_path" "$size" "$hash"
            ' _ {} "$target_dir_prefix"
        else
            find "$target_dir" -maxdepth 1 -type f -printf '%f|%s\n' | \
            while IFS='|' read -r rel_path size; do
                case "$rel_path" in
                    *[\",]*) printf '"%s",%s\n' "${rel_path//\"/\"\"}" "$size" ;;
                    *) printf '%s,%s\n' "$rel_path" "$size" ;;
                esac
            done
        fi
    fi
} > "$output_file"

file_count=$(( $(wc -l < "$output_file") - 1 ))
echo "âœ… CSV å·²ç”Ÿæˆï¼š$output_file ($file_count ä¸ªæ–‡ä»¶)"
