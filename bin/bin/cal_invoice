#!/bin/bash

# ç®€æ´ç‰ˆå‘ç¥¨è®¡ç®—å™¨
# ç”¨æ³•: ./cal_invoice_simple [ç›®å½•]

TOTAL=0
COUNT=0

process_dir() {
    local dir="${1:-.}"
    echo "ğŸ“ $dir"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    local dir_total=0
    local dir_count=0
    
    # æŸ¥æ‰¾å¹¶æ’åºæ–‡ä»¶ï¼ˆWindowsæ ¼å¼æ’åºï¼‰
    find "$dir" -maxdepth 1 -type f -name '*_*_*' | sort -V | while IFS= read -r file; do
        name=$(basename "$file")
        if [[ $name =~ ^([0-9]+)_([0-9.]+)_ ]]; then
            num="${BASH_REMATCH[1]}"
            amount="${BASH_REMATCH[2]}"
            
            ext="${name##*.}"
            printf "%-4s â”‚ Â¥%-8s â”‚ %-6s â”‚ %s\n" "$num" "$amount" "$ext" "${name%.*}"
            
            # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ä¼ é€’å˜é‡ï¼ˆå­shellé™åˆ¶ï¼‰
            echo "$amount" >> /tmp/invoice_total.$$
            echo "1" >> /tmp/invoice_count.$$
        fi
    done
    
    # è®¡ç®—æ€»å’Œ
    if [[ -f /tmp/invoice_total.$$ ]]; then
        dir_total=$(awk '{s+=$1} END {printf "%.2f", s}' /tmp/invoice_total.$$)
        dir_count=$(wc -l < /tmp/invoice_count.$$)
        
        rm -f /tmp/invoice_total.$$ /tmp/invoice_count.$$
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        printf "ğŸ“Š æ–‡ä»¶: %d ä¸ª  æ€»è®¡: Â¥%.2f\n" "$dir_count" "$dir_total"
        echo
        
        # æ›´æ–°å…¨å±€å˜é‡
        echo "$dir_total" >> /tmp/grand_total.$$
        echo "$dir_count" >> /tmp/grand_count.$$
    else
        echo "âš ï¸  æœªæ‰¾åˆ°å‘ç¥¨æ–‡ä»¶"
        echo
    fi
}

# ä¸»ç¨‹åº
main() {
    rm -f /tmp/grand_total.$$ /tmp/grand_count.$$
    
    if [[ $# -eq 0 ]]; then
        process_dir "."
    else
        for dir in "$@"; do
            [[ -d "$dir" ]] && process_dir "$dir"
        done
    fi
    
    # æ˜¾ç¤ºæ€»è®¡
    if [[ -f /tmp/grand_total.$$ ]]; then
        total=$(awk '{s+=$1} END {printf "%.2f", s}' /tmp/grand_total.$$)
        count=$(awk '{s+=$1} END {print s}' /tmp/grand_count.$$)
        
        echo "ğŸ¯ æ€»è®¡ï¼š$count ä¸ªæ–‡ä»¶ï¼ŒÂ¥$total"
        
        rm -f /tmp/grand_total.$$ /tmp/grand_count.$$
    fi
}

main "$@"