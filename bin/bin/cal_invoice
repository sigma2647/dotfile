#!/usr/bin/env bash

# cal_invoice_fastï¼šé«˜æ€§èƒ½ä¿®å¤ç‰ˆå‘ç¥¨è®¡ç®—å™¨
# ç”¨æ³•: ./cal_invoice_fast [ç›®å½•1 ç›®å½•2 ...]

TOTAL=0
COUNT=0

process_dir() {
    local dir="${1:-.}"
    echo "ğŸ“ $dir"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    local dir_total=0
    local dir_count=0
    local amounts=()

    # âš ï¸ ç”¨ process substitution é¿å…å­ shell
    while IFS= read -r file; do
        name=$(basename "$file")
        if [[ $name =~ ^([0-9]+)_([0-9.]+)_ ]]; then
            num="${BASH_REMATCH[1]}"
            amount="${BASH_REMATCH[2]}"
            ext="${name##*.}"

            printf "%-4s â”‚ Â¥%-8s â”‚ %-6s â”‚ %s\n" "$num" "$amount" "$ext" "${name%.*}"

            amounts+=("$amount")
            ((dir_count++))
        fi
    done < <(find "$dir" -maxdepth 1 -type f -name '*_*_*' | sort -V)

    if (( dir_count > 0 )); then
        dir_total=$(printf "%s\n" "${amounts[@]}" | awk '{s+=$1} END {printf "%.2f", s}')

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        printf "ğŸ“Š æ–‡ä»¶: %d ä¸ª  æ€»è®¡: Â¥%.2f\n" "$dir_count" "$dir_total"
        echo

        # ç´¯è®¡å…¨å±€ç»Ÿè®¡
        TOTAL=$(awk -v sum="$TOTAL" -v dsum="$dir_total" 'BEGIN {printf "%.2f", sum + dsum}')
        COUNT=$((COUNT + dir_count))
    else
        echo "âš ï¸  æœªæ‰¾åˆ°å‘ç¥¨æ–‡ä»¶"
        echo
    fi
}

main() {
    TOTAL=0
    COUNT=0

    if [[ $# -eq 0 ]]; then
        process_dir "."
    else
        for dir in "$@"; do
            [[ -d "$dir" ]] && process_dir "$dir"
        done
    fi

    echo "ğŸ¯ æ€»è®¡ï¼š$COUNT ä¸ªæ–‡ä»¶ï¼ŒÂ¥$TOTAL"
}

main "$@"

